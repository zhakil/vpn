# 系统整体架构设计

## 架构概述

基于混合分层架构的代理管理系统，提供统一管理界面和协议专用优化。

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户访问层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Web管理界面  │  移动端APP  │  API客户端  │  命令行工具           │
├─────────────────────────────────────────────────────────────────┤
│                      负载均衡层                                   │
├─────────────────────────────────────────────────────────────────┤
│           Nginx反向代理 + SSL终结 + 限流防护                      │
├─────────────────────────────────────────────────────────────────┤
│                      API网关层                                   │
├─────────────────────────────────────────────────────────────────┤
│  身份认证  │  权限控制  │  请求路由  │  限流熔断  │  日志审计      │
├─────────────────────────────────────────────────────────────────┤
│                      业务服务层                                  │
├─────────────────────────────────────────────────────────────────┤
│ 用户管理服务 │ 规则引擎服务 │ 配置管理服务 │ 监控统计服务         │
├─────────────────────────────────────────────────────────────────┤
│                   协议适配器层                                   │
├─────────────────────────────────────────────────────────────────┤
│ V2Ray适配器 │ Clash适配器 │ Hysteria适配器 │ 插件适配器          │
├─────────────────────────────────────────────────────────────────┤
│                   协议实例层                                     │
├─────────────────────────────────────────────────────────────────┤
│   V2Ray实例   │   Clash实例   │ Hysteria实例  │   插件实例        │
├─────────────────────────────────────────────────────────────────┤
│                     数据层                                      │
├─────────────────────────────────────────────────────────────────┤
│ PostgreSQL │    Redis    │  InfluxDB   │  文件存储  │  日志存储   │
└─────────────────────────────────────────────────────────────────┘
```

## 核心设计原则

### 1. 分层解耦原则
- **用户界面层**：多端适配，统一体验
- **API网关层**：统一入口，安全控制
- **业务服务层**：微服务架构，独立扩展
- **协议适配层**：专业优化，性能最优
- **数据存储层**：分类存储，专业数据库

### 2. 混合架构原则
- **统一管理**：简单规则统一配置
- **协议专用**：高级功能专业优化
- **渐进增强**：从简单到复杂平滑升级

### 3. 高可用原则
- **无单点故障**：所有组件支持集群部署
- **优雅降级**：组件故障时保持基本功能
- **快速恢复**：故障自动检测和恢复

## 组件职责划分

### API网关服务
```yaml
职责:
  - 统一API入口管理
  - 身份认证和权限控制
  - 请求路由和负载均衡
  - 限流熔断和安全防护
  - 审计日志和监控

技术栈:
  - 语言: Go/Node.js
  - 框架: Gin/Express
  - 认证: JWT
  - 限流: Redis + Token Bucket
  - 监控: Prometheus
```

### 规则引擎服务
```yaml
职责:
  - 统一规则格式定义
  - 规则验证和冲突检测
  - 规则优化和压缩
  - 规则版本管理
  - 规则分发协调

核心功能:
  - 支持多种规则类型（域名、IP、端口、协议）
  - 规则优先级和冲突解决
  - 规则模板和批量导入
  - 规则生效时间和定时任务
  - 规则统计和分析
```

### 协议适配器服务
```yaml
设计模式:
  - 插件式架构
  - 统一适配器接口
  - 协议专用实现
  - 配置转换引擎
  - 健康检查机制

支持协议:
  - V2Ray系列: VMess, VLESS, Trojan, Shadowsocks
  - Clash系列: 所有Clash支持的协议
  - 高性能系列: Hysteria, TUIC, WireGuard
  - 扩展协议: 通过插件系统支持
```

### 监控统计服务
```yaml
监控指标:
  - 系统指标: CPU、内存、磁盘、网络
  - 应用指标: 请求量、响应时间、错误率
  - 业务指标: 用户活跃、流量统计、协议性能
  - 自定义指标: 规则匹配、节点状态

数据流转:
  - 实时数据: Redis缓存
  - 历史数据: InfluxDB存储
  - 统计报表: PostgreSQL聚合
  - 日志数据: ELK/Loki收集
```

## 数据流向设计

### 配置下发流程
```
用户操作 → Web界面 → API网关 → 业务服务 → 规则引擎 
→ 协议适配器 → 协议实例配置 → 热重载生效
```

### 流量统计流程  
```
协议实例 → 监控采集 → InfluxDB存储 → 统计服务聚合 
→ Redis缓存 → API接口 → 前端展示
```

### 告警处理流程
```
监控检测 → 告警规则匹配 → 通知服务 → 多渠道推送
→ 自动处理 → 问题修复 → 状态更新
```

## 扩展性设计

### 水平扩展
- **API网关**：无状态设计，支持负载均衡
- **业务服务**：微服务架构，独立扩展  
- **协议实例**：容器化部署，按需扩容
- **数据库**：读写分离，分库分表

### 功能扩展
- **插件系统**：新协议通过插件扩展
- **规则引擎**：支持自定义规则类型
- **监控系统**：支持自定义指标和告警
- **认证系统**：支持多种认证方式集成

## 安全架构设计

### 网络安全
- **SSL/TLS**：全链路加密通信
- **VPN隧道**：管理流量隔离
- **防火墙**：端口和IP访问控制
- **DDoS防护**：流量清洗和限制

### 应用安全  
- **身份认证**：多因素认证支持
- **权限控制**：细粒度RBAC
- **数据加密**：敏感数据加密存储
- **审计日志**：完整的操作记录

### 运维安全
- **密钥管理**：证书和密钥轮换
- **备份加密**：数据备份加密
- **安全扫描**：定期安全检测
- **应急响应**：安全事件处理流程